<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visionneuse PDF avec Photos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: #e0e0e0; height: 100vh; display: flex; flex-direction: column; }
        
        header { background: #2d2d2d; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #ff6b35; z-index: 1000; }
        
        /* Fenêtre de chargement des photos */
        #uploadOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
        }
        .upload-card {
            background: #2d2d2d; padding: 2rem; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center; max-width: 400px;
        }
        .upload-card h2 { margin-bottom: 1.5rem; color: #ff6b35; }
        .file-input-group { margin-bottom: 1rem; text-align: left; }
        .file-input-group label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; }
        input[type="file"] { width: 100%; background: #3d3d3d; padding: 0.5rem; border-radius: 4px; color: white; border: 1px solid #555; }
        
        #startBtn { 
            margin-top: 1rem; width: 100%; padding: 0.8rem; 
            background: #ff6b35; color: white; border: none; border-radius: 6px; 
            font-weight: bold; cursor: pointer; 
        }
        #startBtn:disabled { background: #555; cursor: not-allowed; }

        .container { flex: 1; margin-top: 0; display: flex; flex-direction: column; }
        #pdfViewer { flex: 1; width: 100%; border: none; background: #0a0a0a; }
        .status-badge { padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.85rem; background: #3a5a7a; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="uploadOverlay">
        <div class="upload-card">
            <h2>Photos Obligatoires</h2>
            <div class="file-input-group">
                <label>Photo 1 (Signature/Preuve) :</label>
                <input type="file" id="photo1" accept="image/*">
            </div>
            <div class="file-input-group">
                <label>Photo 2 (ID/Document) :</label>
                <input type="file" id="photo2" accept="image/*">
            </div>
            <button id="startBtn" disabled>Générer le document</button>
        </div>
    </div>

    <header>
        <div class="header-left">
            <div id="fileName" style="font-weight: bold;">PDF Viewer</div>
            <span class="status-badge" id="statusText">En attente des photos...</span>
        </div>
        <button id="downloadBtn" style="background:#ff6b35; color:white; padding:0.5rem 1rem; border-radius:4px; border:none; cursor:pointer;" disabled>⬇️ Télécharger</button>
    </header>

    <div class="container">
        <iframe id="pdfViewer" class="hidden"></iframe>
    </div>

    <script>
        const { PDFDocument, rgb } = PDFLib;
        const POSITIONS_FIXES = [
            { x: 50,  y: 750 }, { x: 100, y: 750 }, { x: 150, y: 750 }, { x: 200, y: 750 },
            { x: 50,  y: 700 }, { x: 100, y: 700 }, { x: 150, y: 700 }, { x: 200, y: 700 },
            { x: 50,  y: 650 }, { x: 100, y: 650 }, { x: 150, y: 650 }, { x: 200, y: 650 },
            { x: 50,  y: 600 }, { x: 100, y: 600 }
        ];

        let currentPdfBlob = null;
        let photo1Data = null;
        let photo2Data = null;

        // --- GESTION DES INPUTS PHOTOS ---
        const photo1Input = document.getElementById('photo1');
        const photo2Input = document.getElementById('photo2');
        const startBtn = document.getElementById('startBtn');

        const checkInputs = () => {
            startBtn.disabled = !(photo1Input.files[0] && photo2Input.files[0]);
        };

        photo1Input.onchange = checkInputs;
        photo2Input.onchange = checkInputs;

        startBtn.onclick = async () => {
            photo1Data = await photo1Input.files[0].arrayBuffer();
            photo2Data = await photo2Input.files[0].arrayBuffer();
            document.getElementById('uploadOverlay').classList.add('hidden');
            document.getElementById('pdfViewer').classList.remove('hidden');
            viewer.init();
        };

        class PDFViewer {
            constructor() {
                const urlParams = new URLSearchParams(window.location.search);
                const rawFileParam = urlParams.get('file') || "";
                const parts = rawFileParam.split('/');
                this.fileName = parts[0]; 
                
                if (parts[1]) {
                    const subParts = parts[1].split(',');
                    this.binaryMask = subParts[0];
                    this.encodedComment = subParts[1] || "";
                }
            }

            async init() {
                try {
                    if (!this.fileName) return;
                    document.getElementById('fileName').textContent = this.fileName;
                    document.getElementById('statusText').textContent = "Traitement en cours...";

                    const pdfBuffer = await fetch(this.fileName).then(res => res.arrayBuffer());
                    currentPdfBlob = await this.processPDF(pdfBuffer);
                    
                    const blobUrl = URL.createObjectURL(currentPdfBlob);
                    document.getElementById('pdfViewer').src = blobUrl;
                    document.getElementById('downloadBtn').disabled = false;
                    document.getElementById('statusText').textContent = "Document prêt ✓";
                } catch (e) {
                    alert("Erreur : " + e.message);
                }
            }

            async processPDF(pdfBuffer) {
                const pdfDoc = await PDFDocument.load(pdfBuffer);
                const firstPage = pdfDoc.getPages()[0];

                // 1. DESSIN DES CROIX
                if (this.binaryMask) {
                    for (let i = 0; i < 14; i++) {
                        if (this.binaryMask[i] === "1" && POSITIONS_FIXES[i]) {
                            const pos = POSITIONS_FIXES[i];
                            this.drawCross(firstPage, pos.x, pos.y);
                        }
                    }
                }

                // 2. INSERTION DES DEUX PHOTOS (En bas du document)
                // On les place à x=50 et x=300 par exemple, à y=100
                const img1 = await this.embedImage(pdfDoc, photo1Data);
                const img2 = await this.embedImage(pdfDoc, photo2Data);

                // On redimensionne pour qu'elles rentrent bien (ex: largeur 150px)
                const dims1 = img1.scale(0.25); 
                const dims2 = img2.scale(0.25);

                firstPage.drawImage(img1, { x: 50, y: 100, width: 150, height: 100 });
                firstPage.drawImage(img2, { x: 250, y: 100, width: 150, height: 100 });

                // 3. COMMENTAIRE
                if (this.encodedComment) {
                    const decoded = decodeURIComponent(escape(window.atob(this.encodedComment)));
                    firstPage.drawText(decoded.substring(0, 100), { x: 50, y: 50, size: 10, color: rgb(0,0,0) });
                }

                const modifiedBuffer = await pdfDoc.save();
                return new Blob([modifiedBuffer], { type: 'application/pdf' });
            }

            async embedImage(pdfDoc, data) {
                // Détecte si c'est du PNG ou du JPG automatiquement
                try { return await pdfDoc.embedJpg(data); }
                catch (e) { return await pdfDoc.embedPng(data); }
            }

            drawCross(page, x, y) {
                const s = 12;
                page.drawLine({ start: {x, y}, end: {x: x+s, y: y+s}, thickness: 2, color: rgb(0,0,0) });
                page.drawLine({ start: {x: x+s, y}, end: {x, y: y+s}, thickness: 2, color: rgb(0,0,0) });
            }
        }

        const viewer = new PDFViewer();
        document.getElementById('downloadBtn').onclick = () => {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(currentPdfBlob);
            link.download = "document_complet.pdf";
            link.click();
        };
    </script>
</body>
</html>
