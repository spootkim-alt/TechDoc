<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur FTC Photos</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #ff6b35;
            --bg-dark: #0f1419;
            --bg-card: #1a1f2e;
            --text-primary: #e8eaed;
            --border: #3a4557;
        }
        body {
            font-family: sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        header {
            background: var(--bg-card);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }
        #uploadOverlay {
            position: fixed; inset: 0;
            background: rgba(15, 20, 25, 0.98);
            z-index: 1000;
            display: flex; justify-content: center; align-items: center;
        }
        .card {
            background: var(--bg-card);
            padding: 2.5rem; border-radius: 16px;
            text-align: center; max-width: 400px;
            border: 1px solid var(--border);
        }
        .upload-area { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
        .upload-zone {
            flex: 1; padding: 1.5rem; border: 2px dashed var(--border);
            border-radius: 12px; cursor: pointer; transition: 0.3s;
        }
        .upload-zone.active { border-color: #4caf50; background: rgba(76, 175, 80, 0.05); }
        button {
            background: var(--primary); color: white; border: none;
            padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer;
            width: 100%;
        }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        #pdfContainer { flex: 1; background: #2c313c; }
        iframe { width: 100%; height: 100%; border: none; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="uploadOverlay">
        <div class="card">
            <h2 style="color: var(--primary); margin-bottom: 15px;">Insertion Photos FTC</h2>
            <p style="font-size: 0.9rem; color: #a8adb5; margin-bottom: 20px;">S√©lectionnez vos deux photos d'intervention</p>
            <div class="upload-area">
                <div class="upload-zone" id="zone1" onclick="document.getElementById('p1').click()">
                    <input type="file" id="p1" accept="image/*" class="hidden">
                    <span>üì∏ Photo 1</span>
                </div>
                <div class="upload-zone" id="zone2" onclick="document.getElementById('p2').click()">
                    <input type="file" id="p2" accept="image/*" class="hidden">
                    <span>üì∏ Photo 2</span>
                </div>
            </div>
            <button id="startBtn" disabled>G√©n√©rer le PDF</button>
        </div>
    </div>

    <header>
        <div style="font-weight:bold; color:var(--primary)">Aper√ßu Document</div>
        <button id="dlBtn" class="hidden" style="width: auto;">‚¨áÔ∏è T√©l√©charger</button>
    </header>

    <main id="pdfContainer">
        <iframe id="viewer"></iframe>
    </main>

    <script>
        const { PDFDocument } = PDFLib;

        // Dimensions fixes pour le centrage
        const PHOTO_WIDTH = 175;
        const PHOTO_HEIGHT = 110;

        let imgBuf1, imgBuf2;
        const urlParams = new URLSearchParams(window.location.search);
        const fileName = urlParams.get('file')?.split('/')[0] || "FTC.pdf";

        // Gestion des fichiers
        ['p1', 'p2'].forEach((id, idx) => {
            const input = document.getElementById(id);
            input.onchange = async (e) => {
                if(e.target.files[0]) {
                    const buf = await e.target.files[0].arrayBuffer();
                    if (id === 'p1') imgBuf1 = buf; else imgBuf2 = buf;
                    document.getElementById('zone' + (idx+1)).classList.add('active');
                    document.getElementById('startBtn').disabled = !(imgBuf1 && imgBuf2);
                }
            };
        });

        document.getElementById('startBtn').onclick = async () => {
            document.getElementById('startBtn').innerText = 'G√©n√©ration...';
            await generate();
            document.getElementById('uploadOverlay').classList.add('hidden');
        };

        async function generate() {
            try {
                const res = await fetch(fileName);
                const pdfBytes = await res.arrayBuffer();
                const pdfDoc = await PDFDocument.load(pdfBytes);
                const page = pdfDoc.getPages()[0];

                // Insertion et centrage des photos
                const i1 = await embed(pdfDoc, imgBuf1);
                const i2 = await embed(pdfDoc, imgBuf2);

                // Photo 1 : Centre √† (170, 220)
                page.drawImage(i1, { 
                    x: 170 - (PHOTO_WIDTH / 2), 
                    y: 220 - (PHOTO_HEIGHT / 2), 
                    width: PHOTO_WIDTH, 
                    height: PHOTO_HEIGHT 
                });

                // Photo 2 : Centre √† (380, 220)
                page.drawImage(i2, { 
                    x: 380 - (PHOTO_WIDTH / 2), 
                    y: 220 - (PHOTO_HEIGHT / 2), 
                    width: PHOTO_WIDTH, 
                    height: PHOTO_HEIGHT 
                });

                const finalBytes = await pdfDoc.save();
                const blob = new Blob([finalBytes], { type: 'application/pdf' });
                const blobUrl = URL.createObjectURL(blob);

                // Affichage
                document.getElementById('viewer').src = blobUrl;
                const dlBtn = document.getElementById('dlBtn');
                dlBtn.classList.remove('hidden');
                
                dlBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = blobUrl;
                    a.download = "FTC_Photos.pdf";
                    a.click();
                };

                // Auto-t√©l√©chargement pour mobile
                if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                    dlBtn.click();
                }

            } catch (e) { alert("Erreur : " + e.message); }
        }

        async function embed(doc, buf) {
            try { return await doc.embedJpg(buf); } catch { return await doc.embedPng(buf); }
        }
    </script>
</body>
</html>
