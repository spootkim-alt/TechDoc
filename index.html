<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTC Photo - Mobile Ready</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, sans-serif;
            background: #0f1419;
            color: #e8eaed;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        .card {
            background: #1a1f2e;
            padding: 2rem;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            border: 1px solid #3a4557;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        h2 { color: #ff6b35; margin-bottom: 20px; }
        .upload-area { display: flex; gap: 15px; margin-bottom: 25px; }
        .upload-zone {
            flex: 1; padding: 20px 10px; border: 2px dashed #3a4557;
            border-radius: 15px; cursor: pointer; background: rgba(255,255,255,0.02);
        }
        .upload-zone.active { border-color: #4caf50; background: rgba(76, 175, 80, 0.1); }
        .upload-zone span { display: block; font-size: 0.8rem; margin-top: 10px; }
        
        #startBtn, #downloadLink {
            display: block; width: 100%; padding: 15px;
            background: #ff6b35; color: white; border: none;
            border-radius: 12px; font-weight: bold; font-size: 1rem;
            text-decoration: none; cursor: pointer; transition: 0.3s;
        }
        #startBtn:disabled { background: #3a4557; cursor: not-allowed; }
        
        #downloadArea { display: none; margin-top: 20px; width: 100%; }
        #downloadLink { background: #4caf50; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="card" id="mainCard">
        <h2>ðŸ“‹ Fiche FTC</h2>
        <p style="margin-bottom: 20px; color: #a8adb5;">Ajoutez les photos pour gÃ©nÃ©rer le PDF</p>

        <div class="upload-area">
            <div class="upload-zone" id="z1" onclick="document.getElementById('p1').click()">
                <input type="file" id="p1" accept="image/*" class="hidden">
                <div style="font-size: 1.5rem;">ðŸ“¸</div>
                <span>Photo 1</span>
            </div>
            <div class="upload-zone" id="z2" onclick="document.getElementById('p2').click()">
                <input type="file" id="p2" accept="image/*" class="hidden">
                <div style="font-size: 1.5rem;">ðŸ“¸</div>
                <span>Photo 2</span>
            </div>
        </div>

        <button id="startBtn" disabled>CRÃ‰ER LE DOCUMENT</button>

        <div id="downloadArea">
            <div style="margin: 20px 0; color: #4caf50; font-weight: bold;">âœ… PDF PrÃªt !</div>
            <a id="downloadLink" href="#">TÃ‰LÃ‰CHARGER LE PDF</a>
            <p style="margin-top: 15px; font-size: 0.8rem; color: #a8adb5;">Cliquez ci-dessus pour ouvrir le fichier</p>
        </div>
    </div>

    <script>
        const { PDFDocument } = PDFLib;
        let img1, img2;
        const urlParams = new URLSearchParams(window.location.search);
        const fileName = urlParams.get('file')?.split('/')[0] || "FTC.pdf";

        // SÃ©lection des fichiers
        document.getElementById('p1').onchange = async (e) => {
            if(e.target.files[0]) {
                img1 = await e.target.files[0].arrayBuffer();
                document.getElementById('z1').classList.add('active');
                check();
            }
        };
        document.getElementById('p2').onchange = async (e) => {
            if(e.target.files[0]) {
                img2 = await e.target.files[0].arrayBuffer();
                document.getElementById('z2').classList.add('active');
                check();
            }
        };

        function check() { document.getElementById('startBtn').disabled = !(img1 && img2); }

        document.getElementById('startBtn').onclick = async function() {
            this.innerText = "Traitement en cours...";
            this.disabled = true;

            try {
                const res = await fetch(fileName);
                const pdfBytes = await res.arrayBuffer();
                const pdfDoc = await PDFDocument.load(pdfBytes);
                const page = pdfDoc.getPages()[0];

                const i1 = await embed(pdfDoc, img1);
                const i2 = await embed(pdfDoc, img2);

                const W = 175, H = 110;
                // Photo 1 centrÃ©e sur (170, 220)
                page.drawImage(i1, { x: 170-(W/2), y: 220-(H/2), width: W, height: H });
                // Photo 2 centrÃ©e sur (380, 220)
                page.drawImage(i2, { x: 380-(W/2), y: 220-(H/2), width: W, height: H });

                const finalBytes = await pdfDoc.save();
                const blob = new Blob([finalBytes], { type: 'application/pdf' });
                const blobUrl = URL.createObjectURL(blob);

                // Affichage du bouton de tÃ©lÃ©chargement final
                document.getElementById('startBtn').classList.add('hidden');
                document.getElementById('downloadArea').style.display = 'block';
                
                const link = document.getElementById('downloadLink');
                link.href = blobUrl;
                link.download = "FTC_Finalise.pdf";

            } catch (err) {
                alert("Erreur: VÃ©rifiez que " + fileName + " est bien au mÃªme endroit que cette page.");
                this.innerText = "CRÃ‰ER LE DOCUMENT";
                this.disabled = false;
            }
        };

        async function embed(doc, buf) {
            try { return await doc.embedJpg(buf); } catch { return await doc.embedPng(buf); }
        }
    </script>
</body>
</html>
