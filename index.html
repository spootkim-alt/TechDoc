<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visionneuse PDF Intelligente</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <style>
        /* Styles de base et remise à zéro */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            background: #121212; 
            color: #ffffff; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* Barre de navigation moderne avec dégradé */
        header { 
            background: linear-gradient(135deg, #1e1e1e 0%, #121212 100%); 
            padding: 1rem 2rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 2px solid #ff6b35; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        /* Overlay (fenêtre surgissante) pour l'upload des photos */
        #uploadOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(5px); /* Effet de flou moderne */
        }

        /* Carte d'interface utilisateur pour l'upload */
        .upload-card {
            background: #252525; padding: 2.5rem; border-radius: 16px;
            width: 90%; max-width: 450px; text-align: center;
            border: 1px solid #333;
        }

        .upload-card h2 { color: #ff6b35; margin-bottom: 1rem; }

        /* Style des zones de sélection de fichiers */
        .file-input {
            background: #1a1a1a; border: 1px solid #444;
            padding: 12px; border-radius: 8px; color: white;
            width: 100%; margin-top: 10px; cursor: pointer;
        }

        /* Bouton principal */
        #startBtn { 
            margin-top: 2rem; width: 100%; padding: 1rem;
            background: #ff6b35; color: white; border: none;
            border-radius: 8px; font-weight: bold; cursor: pointer;
            transition: 0.3s;
        }

        #startBtn:disabled { background: #444; cursor: not-allowed; opacity: 0.6; }

        /* Conteneur du PDF */
        #pdfContainer { flex: 1; display: flex; }
        iframe { width: 100%; height: 100%; border: none; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="uploadOverlay" class="hidden">
        <div class="upload-card">
            <h2>Processus FTC</h2>
            <p style="color: #aaa; margin-bottom: 20px;">Veuillez joindre les deux photos obligatoires.</p>
            <input type="file" id="photo1" class="file-input" accept="image/*">
            <input type="file" id="photo2" class="file-input" accept="image/*">
            <button id="startBtn" disabled>Générer le PDF sécurisé</button>
        </div>
    </div>

    <header>
        <div id="docTitle" style="font-weight: bold;">Chargement du document...</div>
        <button id="dlBtn" class="hidden" style="background:#ff6b35; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;">Télécharger</button>
    </header>

    <main id="pdfContainer">
        <iframe id="viewer" class="hidden"></iframe>
    </main>

    <script>
        const { PDFDocument, rgb } = PDFLib;

        // Configuration des coordonnées pour le document FTC.pdf
        const FTC_POSITIONS = [
            { x: 50, y: 750 }, { x: 100, y: 750 }, { x: 150, y: 750 }, { x: 200, y: 750 },
            { x: 50, y: 700 }, { x: 100, y: 700 }, { x: 150, y: 700 }, { x: 200, y: 700 },
            { x: 50, y: 650 }, { x: 100, y: 650 }, { x: 150, y: 650 }, { x: 200, y: 650 },
            { x: 50, y: 600 }, { x: 100, y: 600 }
        ];

        // --- GESTION DES VARIABLES GLOBALES ---
        let finalBlob = null;
        const urlParams = new URLSearchParams(window.location.search);
        const rawFile = urlParams.get('file') || "";
        const [fileName, extraData] = rawFile.split('/'); // Sépare "FTC.pdf" de "1010...,Base64"

        // --- INITIALISATION AU CHARGEMENT ---
        window.onload = () => {
            if (fileName === "FTC.pdf") {
                // Affiche l'overlay spécifique à FTC
                document.getElementById('uploadOverlay').classList.remove('hidden');
            } else {
                // Pour les autres documents, chargement direct sans modification
                loadSimplePDF();
            }
        };

        // --- GESTIONNAIRE D'INPUTS POUR FTC ---
        const photo1 = document.getElementById('photo1');
        const photo2 = document.getElementById('photo2');
        const btn = document.getElementById('startBtn');

        [photo1, photo2].forEach(input => {
            input.onchange = () => { btn.disabled = !(photo1.files[0] && photo2.files[0]); };
        });

        // --- ACTION AU CLIC SUR GENERER ---
        btn.onclick = async () => {
            document.getElementById('uploadOverlay').classList.add('hidden');
            const p1 = await photo1.files[0].arrayBuffer();
            const p2 = await photo2.files[0].arrayBuffer();
            processFTC(p1, p2);
        };

        // --- FONCTION SPECIFIQUE : FTC.pdf ---
        async function processFTC(buf1, buf2) {
            try {
                // 1. Récupération du fichier original
                const res = await fetch(fileName);
                const pdfBytes = await res.arrayBuffer();
                const pdfDoc = await PDFDocument.load(pdfBytes);
                const page = pdfDoc.getPages()[0];

                // 2. Traitement du masque binaire (croix)
                if (extraData) {
                    const [mask, commentBase64] = extraData.split(',');
                    
                    // Dessin des croix selon les 0 et 1
                    for(let i=0; i<14; i++) {
                        if(mask[i] === "1") {
                            const pos = FTC_POSITIONS[i];
                            drawCross(page, pos.x, pos.y);
                        }
                    }

                    // Ajout du commentaire avec TextDecoder (évite erreur URI malformed)
                    if (commentBase64) {
                        const bytes = Uint8Array.from(atob(commentBase64.trim()), c => c.charCodeAt(0));
                        const text = new TextDecoder().decode(bytes).substring(0, 100);
                        page.drawText(text, { x: 50, y: 40, size: 10, color: rgb(0,0,0) });
                    }
                }

                // 3. Insertion des photos uploadées
                const img1 = await embedImg(pdfDoc, buf1);
                const img2 = await embedImg(pdfDoc, buf2);
                page.drawImage(img1, { x: 50, y: 80, width: 140, height: 90 });
                page.drawImage(img2, { x: 210, y: 80, width: 140, height: 90 });

                // 4. Finalisation et affichage
                displayPDF(await pdfDoc.save());
            } catch (e) { alert("Erreur FTC: " + e.message); }
        }

        // --- FONCTION SIMPLE : Autres Documents ---
        async function loadSimplePDF() {
            try {
                const res = await fetch(fileName);
                if(!res.ok) throw new Error("Fichier introuvable");
                displayPDF(await res.arrayBuffer());
            } catch (e) { document.getElementById('docTitle').innerText = e.message; }
        }

        // --- OUTILS PRATIQUES ---

        // Affiche le PDF final dans l'iframe
        function displayPDF(bytes) {
            finalBlob = new Blob([bytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(finalBlob);
            const viewer = document.getElementById('viewer');
            viewer.src = url;
            viewer.classList.remove('hidden');
            document.getElementById('docTitle').innerText = fileName;
            document.getElementById('dlBtn').classList.remove('hidden');
        }

        // Téléchargement du fichier
        document.getElementById('dlBtn').onclick = () => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(finalBlob);
            a.download = "signe_" + fileName;
            a.click();
        };

        // Dessine une croix noire
        function drawCross(page, x, y) {
            const s = 12;
            page.drawLine({ start: {x, y}, end: {x: x+s, y: y+s}, thickness: 2, color: rgb(0,0,0) });
            page.drawLine({ start: {x: x+s, y}, end: {x, y: y+s}, thickness: 2, color: rgb(0,0,0) });
        }

        // Intègre une image (JPG ou PNG)
        async function embedImg(doc, buf) {
            try { return await doc.embedJpg(buf); } 
            catch { return await doc.embedPng(buf); }
        }
    </script>
</body>
</html>
