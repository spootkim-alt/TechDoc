<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visionneuse PDF Dynamique</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: #e0e0e0; height: 100vh; display: flex; flex-direction: column; }
        header { background: linear-gradient(135deg, #2d2d2d 0%, #1f1f1f 100%); padding: 1.2rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); border-bottom: 2px solid #ff6b35; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .file-name { font-size: 1.1rem; font-weight: 600; color: #ffffff; word-break: break-word; max-width: 60%; }
        .status-badge { padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.85rem; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem; }
        .status-badge.loading { background: #3a5a7a; color: #64b5f6; }
        .status-badge.success { background: #2d5a3d; color: #81c784; }
        .status-badge.error { background: #5a2d2d; color: #ef5350; }
        .header-right { display: flex; gap: 1rem; align-items: center; }
        button { padding: 0.7rem 1.5rem; border: none; border-radius: 6px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; }
        .btn-download { background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%); color: white; box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3); }
        .btn-download:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(255, 107, 53, 0.4); }
        .btn-download:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .container { display: flex; flex-direction: column; flex: 1; margin-top: 80px; overflow: hidden; }
        .message-container { padding: 2rem; text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .error-message { color: #ef5350; font-size: 1.2rem; margin-bottom: 1rem; }
        .error-details { color: #b0bec5; font-size: 0.95rem; font-family: 'Courier New', monospace; }
        #pdfViewer { flex: 1; width: 100%; height: 100%; border: none; background: #0a0a0a; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <div class="file-name" id="fileName">PDF Viewer</div>
            <span class="status-badge loading" id="statusBadge">
                <span id="statusText">Initialisation...</span>
            </span>
        </div>
        <div class="header-right">
            <button class="btn-download" id="downloadBtn" disabled>⬇️ Télécharger</button>
        </div>
    </header>

    <div class="container">
        <div class="message-container hidden" id="messageContainer">
            <div id="messageContent"></div>
        </div>
        <iframe id="pdfViewer" title="Visionneuse PDF"></iframe>
    </div>

    <script>
        // --- 1. CONFIGURATION DES 14 POSITIONS FIXES ---
        // Modifie les x et y ici pour correspondre aux cases de ton document
        const POSITIONS_FIXES = [
            { x: 50,  y: 750 }, { x: 100, y: 750 }, { x: 150, y: 750 }, { x: 200, y: 750 },
            { x: 50,  y: 700 }, { x: 100, y: 700 }, { x: 150, y: 700 }, { x: 200, y: 700 },
            { x: 50,  y: 650 }, { x: 100, y: 650 }, { x: 150, y: 650 }, { x: 200, y: 650 },
            { x: 50,  y: 600 }, { x: 100, y: 600 }
        ];

        const PDFLib = window.PDFLib;
        const { PDFDocument, rgb } = PDFLib;
        let currentPdfBlob = null;
        let isModified = false;

        class PDFViewer {
            constructor() {
                const urlParams = new URLSearchParams(window.location.search);
                const rawFileParam = urlParams.get('file') || "";
                
                // Analyse : FTC.pdf/101010...,CommentaireBase64
                const parts = rawFileParam.split('/');
                this.fileName = parts[0]; 
                
                this.binaryMask = "";
                this.encodedComment = "";

                if (parts[1]) {
                    const subParts = parts[1].split(',');
                    this.binaryMask = subParts[0]; // Les 14 chiffres
                    this.encodedComment = subParts[1] || ""; // Le base64
                }

                this.init();
            }

            async init() {
                try {
                    if (!this.fileName) {
                        this.showError('Paramètre manquant', 'Format: ?file=nom.pdf/101010...,Base64');
                        return;
                    }

                    document.getElementById('fileName').textContent = this.fileName;
                    this.updateStatus('Chargement...', 'loading');

                    const pdfBuffer = await this.fetchPDF(this.fileName);
                    
                    // On modifie le PDF si un masque binaire ou un commentaire est présent
                    if (this.binaryMask || this.encodedComment) {
                        currentPdfBlob = await this.processPDF(pdfBuffer);
                        isModified = true;
                        this.updateStatus('Document traité ✓', 'success');
                    } else {
                        currentPdfBlob = new Blob([pdfBuffer], { type: 'application/pdf' });
                        this.updateStatus('Original ✓', 'success');
                    }

                    this.displayPDF(currentPdfBlob);
                    document.getElementById('downloadBtn').disabled = false;
                } catch (error) {
                    this.showError('Erreur', error.message);
                    this.updateStatus('Erreur', 'error');
                }
            }

            async fetchPDF(fileName) {
                const response = await fetch(fileName);
                if (!response.ok) throw new Error(`Fichier "${fileName}" non trouvé`);
                return await response.arrayBuffer();
            }

            async processPDF(pdfBuffer) {
                const pdfDoc = await PDFDocument.load(pdfBuffer);
                const firstPage = pdfDoc.getPages()[0];
                const crossSize = 12;

                // 1. DESSIN DES CROIX (Basé sur le masque de 14 chiffres)
                if (this.binaryMask) {
                    for (let i = 0; i < 14; i++) {
                        if (this.binaryMask[i] === "1" && POSITIONS_FIXES[i]) {
                            const pos = POSITIONS_FIXES[i];
                            firstPage.drawLine({
                                start: { x: pos.x, y: pos.y },
                                end: { x: pos.x + crossSize, y: pos.y + crossSize },
                                thickness: 2, color: rgb(0, 0, 0)
                            });
                            firstPage.drawLine({
                                start: { x: pos.x + crossSize, y: pos.y },
                                end: { x: pos.x, y: pos.y + crossSize },
                                thickness: 2, color: rgb(0, 0, 0)
                            });
                        }
                    }
                }

                // 2. AJOUT DU COMMENTAIRE (Décodage Base64)
                if (this.encodedComment) {
                    try {
                        // Décodage Base64 supportant les accents
                        const decoded = decodeURIComponent(escape(window.atob(this.encodedComment)));
                        const commentText = decoded.substring(0, 100); // Max 100 caractères

                        firstPage.drawText(commentText, {
                            x: 50,
                            y: 50, // Position du commentaire en bas à gauche
                            size: 11,
                            color: rgb(0, 0, 0)
                        });
                    } catch (e) {
                        console.error("Erreur Base64:", e);
                    }
                }

                const modifiedBuffer = await pdfDoc.save();
                return new Blob([modifiedBuffer], { type: 'application/pdf' });
            }

            displayPDF(blob) {
                const blobUrl = URL.createObjectURL(blob);
                document.getElementById('pdfViewer').src = blobUrl;
                document.getElementById('messageContainer').classList.add('hidden');
            }

            showError(title, message) {
                const msgContainer = document.getElementById('messageContainer');
                const msgContent = document.getElementById('messageContent');
                msgContent.innerHTML = `<div class="error-message">❌ ${title}</div><div class="error-details">${message}</div>`;
                msgContainer.classList.remove('hidden');
                document.getElementById('pdfViewer').classList.add('hidden');
            }

            updateStatus(text, type) {
                const badge = document.getElementById('statusBadge');
                document.getElementById('statusText').textContent = text;
                badge.className = `status-badge ${type}`;
            }

            downloadPDF() {
                if (!currentPdfBlob) return;
                const link = document.createElement('a');
                link.href = URL.createObjectURL(currentPdfBlob);
                link.download = `traite_${this.fileName}`;
                link.click();
            }
        }

        const viewer = new PDFViewer();
        document.getElementById('downloadBtn').addEventListener('click', () => viewer.downloadPDF());
    </script>
</body>
</html>
