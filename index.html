<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visionneuse PDF Intelligente - Mode Mesure</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <style>
        /* Styles de base */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            background: #121212; 
            color: #ffffff; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* Header */
        header { 
            background: linear-gradient(135deg, #1e1e1e 0%, #121212 100%); 
            padding: 1rem 2rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 2px solid #ff6b35; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            z-index: 10;
        }

        /* Overlay Upload */
        #uploadOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }

        .upload-card {
            background: #252525; padding: 2.5rem; border-radius: 16px;
            width: 90%; max-width: 450px; text-align: center;
            border: 1px solid #333;
        }

        .file-input {
            background: #1a1a1a; border: 1px solid #444;
            padding: 12px; border-radius: 8px; color: white;
            width: 100%; margin-top: 10px; cursor: pointer;
        }

        #startBtn { 
            margin-top: 2rem; width: 100%; padding: 1rem;
            background: #ff6b35; color: white; border: none;
            border-radius: 8px; font-weight: bold; cursor: pointer;
        }
        #startBtn:disabled { background: #444; opacity: 0.6; }

        /* Conteneur PDF et Système de Mesure */
        #pdfContainer { 
            flex: 1; 
            position: relative; 
            display: flex; 
            background: #333;
        }
        
        iframe { width: 100%; height: 100%; border: none; }

        /* Bulle d'info qui suit la souris */
        #coords-tooltip {
            position: fixed;
            background: #ff6b35;
            color: white;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: bold;
            pointer-events: none;
            z-index: 3000;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            border: 1px solid white;
        }

        /* Calque pour capter la souris sur l'iframe */
        #pdfOverlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1500;
            cursor: crosshair;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="coords-tooltip">X: 0, Y: 0</div>

    <div id="uploadOverlay" class="hidden">
        <div class="upload-card">
            <h2>Processus FTC</h2>
            <p style="color: #aaa; margin-bottom: 20px;">Joignez les photos pour activer la mesure.</p>
            <input type="file" id="photo1" class="file-input" accept="image/*">
            <input type="file" id="photo2" class="file-input" accept="image/*">
            <button id="startBtn" disabled>Générer et Mesurer</button>
        </div>
    </div>

    <header>
        <div id="docTitle" style="font-weight: bold;">En attente de fichier...</div>
        <div style="display: flex; gap: 10px;">
            <span style="font-size: 0.8rem; color: #ff6b35; align-self: center;">Mode Mesure Actif</span>
            <button id="dlBtn" class="hidden" style="background:#ff6b35; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;">Télécharger</button>
        </div>
    </header>

    <main id="pdfContainer">
        <div id="pdfOverlay" class="hidden"></div>
        <iframe id="viewer" class="hidden"></iframe>
    </main>

    <script>
        const { PDFDocument, rgb } = PDFLib;

        // --- CONFIGURATION DES POSITIONS ---
        // Utilise la bulle de souris pour ajuster ces valeurs
        const FTC_POSITIONS = [
            { x: 50, y: 750 }, { x: 100, y: 750 }, { x: 150, y: 750 }, { x: 200, y: 750 },
            { x: 50, y: 700 }, { x: 100, y: 700 }, { x: 150, y: 700 }, { x: 200, y: 700 },
            { x: 50, y: 650 }, { x: 100, y: 650 }, { x: 150, y: 650 }, { x: 200, y: 650 },
            { x: 50, y: 600 }, { x: 100, y: 600 }
        ];

        let finalBlob = null;
        const urlParams = new URLSearchParams(window.location.search);
        const rawFile = urlParams.get('file') || "";
        const [fileName, extraData] = rawFile.split('/');

        const tooltip = document.getElementById('coords-tooltip');
        const overlay = document.getElementById('pdfOverlay');

        window.onload = () => {
            if (fileName === "FTC.pdf") {
                document.getElementById('uploadOverlay').classList.remove('hidden');
            } else {
                loadSimplePDF();
            }
        };

        // --- GESTION DES UPLOADS ---
        const photo1 = document.getElementById('photo1');
        const photo2 = document.getElementById('photo2');
        const btn = document.getElementById('startBtn');

        [photo1, photo2].forEach(input => {
            input.onchange = () => { btn.disabled = !(photo1.files[0] && photo2.files[0]); };
        });

        btn.onclick = async () => {
            document.getElementById('uploadOverlay').classList.add('hidden');
            const p1 = await photo1.files[0].arrayBuffer();
            const p2 = await photo2.files[0].arrayBuffer();
            processFTC(p1, p2);
        };

        // --- GENERATION DU PDF ---
        async function processFTC(buf1, buf2) {
            try {
                const res = await fetch(fileName);
                const pdfBytes = await res.arrayBuffer();
                const pdfDoc = await PDFDocument.load(pdfBytes);
                const page = pdfDoc.getPages()[0];

                // 1. Dessin des croix
                if (extraData) {
                    const [mask, commentBase64] = extraData.split(',');
                    for(let i=0; i<14; i++) {
                        if(mask[i] === "1") {
                            const pos = FTC_POSITIONS[i];
                            drawCross(page, pos.x, pos.y);
                        }
                    }
                }

                // 2. Photos (ajuste x, y, width, height ici)
                const img1 = await embedImg(pdfDoc, buf1);
                const img2 = await embedImg(pdfDoc, buf2);
                page.drawImage(img1, { x: 50, y: 80, width: 140, height: 90 });
                page.drawImage(img2, { x: 210, y: 80, width: 140, height: 90 });

                displayPDF(await pdfDoc.save());
            } catch (e) { alert("Erreur: " + e.message); }
        }

        async function loadSimplePDF() {
            try {
                const res = await fetch(fileName);
                displayPDF(await res.arrayBuffer());
            } catch (e) { document.getElementById('docTitle').innerText = "Fichier non trouvé"; }
        }

        function displayPDF(bytes) {
            finalBlob = new Blob([bytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(finalBlob);
            const viewer = document.getElementById('viewer');
            viewer.src = url;
            viewer.classList.remove('hidden');
            document.getElementById('docTitle').innerText = fileName;
            document.getElementById('dlBtn').classList.remove('hidden');
            
            enableMouseCoords(); // Active la bulle de mesure
        }

        // --- SYSTEME DE MESURE ---
        function enableMouseCoords() {
            overlay.classList.remove('hidden');
            overlay.onmousemove = (e) => {
                const rect = overlay.getBoundingClientRect();
                const relX = (e.clientX - rect.left) / rect.width;
                const relY = (e.clientY - rect.top) / rect.height;

                // Coordonnées PDF (A4 standard: 595 x 842 points)
                const pdfX = Math.round(relX * 595);
                const pdfY = Math.round((1 - relY) * 842); // Inverse car 0 est en bas

                tooltip.style.display = 'block';
                tooltip.style.left = (e.clientX + 15) + 'px';
                tooltip.style.top = (e.clientY + 15) + 'px';
                tooltip.innerText = `X: ${pdfX}, Y: ${pdfY}`;
            };
            
            overlay.onmouseleave = () => { tooltip.style.display = 'none'; };
            
            overlay.onclick = (e) => {
                console.log(`CLIC : { x: ${tooltip.innerText.split(',')[0].split(':')[1].trim()}, y: ${tooltip.innerText.split(',')[1].split(':')[1].trim()} }`);
            };
        }

        function drawCross(page, x, y) {
            const s = 12;
            page.drawLine({ start: {x, y}, end: {x: x+s, y: y+s}, thickness: 2, color: rgb(0,0,0) });
            page.drawLine({ start: {x: x+s, y}, end: {x, y: y+s}, thickness: 2, color: rgb(0,0,0) });
        }

        async function embedImg(doc, buf) {
            try { return await doc.embedJpg(buf); } 
            catch { return await doc.embedPng(buf); }
        }

        document.getElementById('dlBtn').onclick = () => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(finalBlob);
            a.download = "signe_" + fileName;
            a.click();
        };
    </script>
</body>
</html>
