<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur FTC - Configuration Finale</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #ff6b35;
            --primary-dark: #e55a2b;
            --bg-dark: #0f1419;
            --bg-card: #1a1f2e;
            --bg-input: #252d3d;
            --border: #3a4557;
            --text-primary: #e8eaed;
            --text-secondary: #a8adb5;
            --success: #4caf50;
            --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ========== HEADER ========== */
        header {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(26, 31, 46, 0.8) 100%);
            padding: 1.2rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        #docTitle {
            font-size: 1.3rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), #ff8c42);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }

        /* ========== BOUTONS ========== */
        button {
            background: linear-gradient(135deg, var(--primary), #ff8c42);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all var(--transition);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.25);
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            transition: left var(--transition);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.35);
        }

        button:hover::before {
            left: 100%;
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .hidden { display: none !important; }

        /* ========== OVERLAY UPLOAD ========== */
        #uploadOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 20, 25, 0.95);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .card {
            background: linear-gradient(135deg, var(--bg-card), rgba(26, 31, 46, 0.7));
            padding: 3rem;
            border-radius: 16px;
            border: 1px solid var(--border);
            text-align: center;
            max-width: 450px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.5s ease-out;
            backdrop-filter: blur(10px);
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .card h2 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary), #ff8c42);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .card p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .upload-area {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .upload-zone {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            padding: 2rem 1rem;
            border: 2px dashed var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all var(--transition);
            background: rgba(255, 107, 53, 0.02);
        }

        .upload-zone:hover {
            border-color: var(--primary);
            background: rgba(255, 107, 53, 0.08);
        }

        .upload-zone input {
            position: absolute;
            width: 0;
            height: 0;
            opacity: 0;
        }

        .upload-icon {
            font-size: 2rem;
            opacity: 0.6;
            transition: transform var(--transition);
        }

        .upload-zone:hover .upload-icon {
            transform: translateY(-4px);
            opacity: 1;
        }

        .upload-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .upload-zone.active {
            border-color: var(--success);
            background: rgba(76, 175, 80, 0.08);
        }

        .upload-zone.active .upload-text {
            color: var(--success);
        }

        .upload-zone.active .upload-icon {
            color: var(--success);
        }

        /* ========== CONTROLS ========== */
        .controls {
            display: flex;
            gap: 2rem;
            background: linear-gradient(135deg, var(--bg-card), rgba(26, 31, 46, 0.6));
            padding: 1.2rem 2rem;
            border-bottom: 1px solid var(--border);
            align-items: center;
            animation: slideDown 0.5s ease-out 0.1s both;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .control-group label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            min-width: 80px;
        }

        input[type="number"] {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.6rem 1rem;
            width: 80px;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all var(--transition);
            font-weight: 500;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
            background: rgba(255, 107, 53, 0.02);
        }

        .control-hint {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-left: auto;
            opacity: 0.7;
        }

        /* ========== PDF CONTAINER ========== */
        #pdfContainer {
            flex: 1;
            background: linear-gradient(135deg, var(--bg-dark) 0%, rgba(26, 31, 46, 0.3) 100%);
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            animation: fadeIn 0.6s ease-out 0.2s both;
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            .card {
                padding: 2rem;
                max-width: 90%;
            }

            .upload-area {
                flex-direction: column;
            }

            .controls {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .control-hint {
                margin-left: 0;
                margin-top: 0.5rem;
            }

            #docTitle {
                font-size: 1.1rem;
            }

            button {
                width: 100%;
            }
        }

        /* ========== LOADING STATE ========== */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 107, 53, 0.3);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .success-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--success);
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .success-badge::before {
            content: '‚úì';
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="uploadOverlay">
        <div class="card">
            <h2>üìã G√©n√©rateur FTC</h2>
            <p>Chargez les photos d'intervention pour g√©n√©rer votre document</p>
            
            <div class="upload-area">
                <div class="upload-zone" onclick="document.getElementById('p1').click()">
                    <input type="file" id="p1" accept="image/*">
                    <div class="upload-icon">üì∏</div>
                    <div class="upload-text">Photo 1</div>
                    <div class="success-badge hidden" id="success1">Charg√©e</div>
                </div>

                <div class="upload-zone" onclick="document.getElementById('p2').click()">
                    <input type="file" id="p2" accept="image/*">
                    <div class="upload-icon">üì∏</div>
                    <div class="upload-text">Photo 2</div>
                    <div class="success-badge hidden" id="success2">Charg√©e</div>
                </div>
            </div>

            <button id="startBtn" disabled>
                <span id="btnText">G√©n√©rer le Document</span>
            </button>
        </div>
    </div>

    <header>
        <div id="docTitle">üìÑ Aper√ßu FTC.pdf</div>
        <button id="dlBtn" class="hidden">‚¨áÔ∏è T√©l√©charger le PDF</button>
    </header>

    <div class="controls">
        <div class="control-group">
            <label for="test-x">Position X:</label>
            <input type="number" id="test-x" value="170" min="0" max="400">
        </div>
        <div class="control-group">
            <label for="test-y">Position Y:</label>
            <input type="number" id="test-y" value="220" min="0" max="500">
        </div>
        <span class="control-hint">üí° Ajustez les positions pour calibrer les photos</span>
    </div>

    <main id="pdfContainer">
        <iframe id="viewer" title="Visionneuse PDF FTC"></iframe>
    </main>

    <script>
        const { PDFDocument, rgb } = PDFLib;

        const FTC_CENTERS = {
            0:  { x: 88,  y: 606 },
            1:  { x: 160, y: 606 },
            2:  { x: 239, y: 624 },
            3:  { x: 242, y: 565 },
            4:  { x: 345, y: 603 },
            5:  { x: 444, y: 606 },
            6:  { x: 108, y: 468 },
            7:  { x: 181, y: 468 },
            8:  { x: 251, y: 468 },
            9:  { x: 326, y: 482 },
            10: { x: 326, y: 461 },
            11: { x: 326, y: 445 },
            12: { x: 326, y: 426 },
            13: { x: 326, y: 416 }
        };

        const CROSS_SIZE = 12;
        const PHOTO_WIDTH = 175;
        const PHOTO_HEIGHT = 110;

        let imgBuf1, imgBuf2;
        const urlParams = new URLSearchParams(window.location.search);
        const rawParam = urlParams.get('file') || "FTC.pdf";
        const [fileName, extraData] = rawParam.split('/');

        // Gestion des uploads
        ['p1', 'p2'].forEach((id, idx) => {
            const input = document.getElementById(id);
            const zone = input.parentElement;
            const successBadge = document.getElementById(`success${idx + 1}`);

            input.addEventListener('change', async (e) => {
                if (e.target.files[0]) {
                    zone.classList.add('active');
                    successBadge.classList.remove('hidden');
                    
                    if (id === 'p1') {
                        imgBuf1 = await e.target.files[0].arrayBuffer();
                    } else {
                        imgBuf2 = await e.target.files[0].arrayBuffer();
                    }
                    
                    checkAllFilesLoaded();
                }
            });

            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.style.borderColor = 'var(--primary)';
                zone.style.background = 'rgba(255, 107, 53, 0.12)';
            });

            zone.addEventListener('dragleave', () => {
                zone.style.borderColor = '';
                zone.style.background = '';
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.style.borderColor = '';
                zone.style.background = '';
                if (e.dataTransfer.files[0]) {
                    input.files = e.dataTransfer.files;
                    input.dispatchEvent(new Event('change'));
                }
            });
        });

        function checkAllFilesLoaded() {
            document.getElementById('startBtn').disabled = !(imgBuf1 && imgBuf2);
        }

        document.getElementById('startBtn').onclick = async () => {
            const btn = document.getElementById('startBtn');
            const btnText = document.getElementById('btnText');
            btnText.innerHTML = '<span class="spinner"></span>G√©n√©ration...';
            btn.disabled = true;

            await new Promise(r => setTimeout(r, 500));
            
            document.getElementById('uploadOverlay').classList.add('hidden');
            btnText.textContent = 'G√©n√©rer le Document';
            await generateFTC();
        };

        document.getElementById('test-x').oninput = () => debounce(generateFTC, 300);
        document.getElementById('test-y').oninput = () => debounce(generateFTC, 300);

        let debounceTimer;
        function debounce(fn, delay) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(fn, delay);
        }

        async function generateFTC() {
            if (!imgBuf1) return;

            try {
                const res = await fetch(fileName);
                const pdfBytes = await res.arrayBuffer();
                const pdfDoc = await PDFDocument.load(pdfBytes);
                const page = pdfDoc.getPages()[0];

                if (extraData) {
                    const [mask, commentBase64] = extraData.split(',');
                    
                    for (let i = 0; i < mask.length; i++) {
                        if (mask[i] === "1" && FTC_CENTERS[i]) {
                            const pos = FTC_CENTERS[i];
                            drawCenteredCross(page, pos.x, pos.y, CROSS_SIZE);
                        }
                    }

                    if (commentBase64) {
                        const bytes = Uint8Array.from(atob(commentBase64.trim()), c => c.charCodeAt(0));
                        const text = new TextDecoder().decode(bytes);
                        page.drawText(text, { x: 345, y: 412, size: 9, color: rgb(0, 0, 0) });
                    }
                }

                const img1 = await embedSafe(pdfDoc, imgBuf1);
                const img2 = await embedSafe(pdfDoc, imgBuf2);

                const tx = parseInt(document.getElementById('test-x').value);
                const ty = parseInt(document.getElementById('test-y').value);

                page.drawImage(img1, {
                    x: tx - (PHOTO_WIDTH / 2),
                    y: ty - (PHOTO_HEIGHT / 2),
                    width: PHOTO_WIDTH,
                    height: PHOTO_HEIGHT
                });

                page.drawImage(img2, {
                    x: tx + 210 - (PHOTO_WIDTH / 2),
                    y: ty - (PHOTO_HEIGHT / 2),
                    width: PHOTO_WIDTH,
                    height: PHOTO_HEIGHT
                });

                const pdfFinal = await pdfDoc.save();
                const blob = new Blob([pdfFinal], { type: 'application/pdf' });
                document.getElementById('viewer').src = URL.createObjectURL(blob);

                document.getElementById('dlBtn').classList.remove('hidden');
                document.getElementById('dlBtn').onclick = () => {
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = "FTC_Finalise.pdf";
                    a.click();
                };

            } catch (e) {
                console.error("Erreur PDF:", e);
            }
        }

        function drawCenteredCross(page, centerX, centerY, size) {
            const half = size / 2;
            const color = rgb(0, 0, 0);

            page.drawLine({
                start: { x: centerX - half, y: centerY + half },
                end: { x: centerX + half, y: centerY - half },
                thickness: 1.5,
                color
            });
            page.drawLine({
                start: { x: centerX - half, y: centerY - half },
                end: { x: centerX + half, y: centerY + half },
                thickness: 1.5,
                color
            });
        }

        async function embedSafe(doc, buf) {
            try { return await doc.embedJpg(buf); }
            catch { return await doc.embedPng(buf); }
        }
    </script>
</body>
</html>
