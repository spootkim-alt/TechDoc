<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visionneuse PDF Dynamique</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <style>
        /* ... Tes styles restent identiques ... */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: #e0e0e0; height: 100vh; display: flex; flex-direction: column; }
        header { background: linear-gradient(135deg, #2d2d2d 0%, #1f1f1f 100%); padding: 1.2rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); border-bottom: 2px solid #ff6b35; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .file-name { font-size: 1.1rem; font-weight: 600; color: #ffffff; word-break: break-word; max-width: 60%; }
        .status-badge { padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.85rem; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem; }
        .status-badge.loading { background: #3a5a7a; color: #64b5f6; }
        .status-badge.success { background: #2d5a3d; color: #81c784; }
        .status-badge.error { background: #5a2d2d; color: #ef5350; }
        .header-right { display: flex; gap: 1rem; align-items: center; }
        button { padding: 0.7rem 1.5rem; border: none; border-radius: 6px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; }
        .btn-download { background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%); color: white; box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3); }
        .btn-download:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(255, 107, 53, 0.4); }
        .btn-download:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .container { display: flex; flex-direction: column; flex: 1; margin-top: 80px; overflow: hidden; }
        .message-container { padding: 2rem; text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .error-message { color: #ef5350; font-size: 1.2rem; margin-bottom: 1rem; }
        .error-details { color: #b0bec5; font-size: 0.95rem; font-family: 'Courier New', monospace; }
        #pdfViewer { flex: 1; width: 100%; height: 100%; border: none; background: #0a0a0a; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <div class="file-name" id="fileName">PDF Viewer</div>
            <span class="status-badge loading" id="statusBadge">
                <span id="statusText">Initialisation...</span>
            </span>
        </div>
        <div class="header-right">
            <button class="btn-download" id="downloadBtn" disabled>⬇️ Télécharger</button>
        </div>
    </header>

    <div class="container">
        <div class="message-container hidden" id="messageContainer">
            <div id="messageContent"></div>
        </div>
        <iframe id="pdfViewer" title="Visionneuse PDF"></iframe>
    </div>

    <script>
        // --- 1. CONFIGURATION DES POSITIONS ---
        // Ajoute ici tes coordonnées selon l'indice /1, /2, etc.
        const CONFIG_CROIX = {
            "1": [
                { x: 100, y: 700 }, // Croix A pour l'option /1
                { x: 120, y: 700 }  // Croix B pour l'option /1
            ],
            "2": [
                { x: 300, y: 400 }  // Une seule croix pour /2
            ],
            "ok": [
                { x: 500, y: 50 }   // Exemple pour /ok
            ]
        };

        const PDFLib = window.PDFLib;
        const { PDFDocument, rgb } = PDFLib;
        let currentPdfBlob = null;
        let isModified = false;

        class PDFViewer {
            constructor() {
                const urlParams = new URLSearchParams(window.location.search);
                const rawFileParam = urlParams.get('file') || "";
                
                // On sépare le nom du fichier et l'option (ex: FTC.pdf/1)
                const parts = rawFileParam.split('/');
                this.fileName = parts[0]; 
                this.optionId = parts[1]; // L'ID après le slash (ex: "1")

                this.init();
            }

            async init() {
                try {
                    if (!this.fileName) {
                        this.showError('Paramètre manquant', 'Utilisez ?file=nom.pdf/1');
                        return;
                    }

                    document.getElementById('fileName').textContent = this.fileName;
                    this.updateStatus('Chargement...', 'loading');

                    const pdfBuffer = await this.fetchPDF(this.fileName);
                    
                    // On vérifie si l'option existe dans notre tableau
                    if (this.optionId && CONFIG_CROIX[this.optionId]) {
                        currentPdfBlob = await this.markPDF(pdfBuffer, CONFIG_CROIX[this.optionId]);
                        isModified = true;
                        this.updateStatus(`Option /${this.optionId} appliquée ✓`, 'success');
                    } else {
                        currentPdfBlob = new Blob([pdfBuffer], { type: 'application/pdf' });
                        this.updateStatus('Document original ✓', 'success');
                    }

                    this.displayPDF(currentPdfBlob);
                    document.getElementById('downloadBtn').disabled = false;
                } catch (error) {
                    this.showError('Erreur', error.message);
                    this.updateStatus('Erreur', 'error');
                }
            }

            async fetchPDF(fileName) {
                const response = await fetch(fileName);
                if (!response.ok) throw new Error(`Fichier "${fileName}" non trouvé`);
                return await response.arrayBuffer();
            }

            async markPDF(pdfBuffer, positions) {
                const pdfDoc = await PDFDocument.load(pdfBuffer);
                const firstPage = pdfDoc.getPages()[0];
                const size = 15; // Taille de la croix

                positions.forEach(pos => {
                    // Ligne 1 de la croix (Noire)
                    firstPage.drawLine({
                        start: { x: pos.x, y: pos.y },
                        end: { x: pos.x + size, y: pos.y + size },
                        thickness: 2,
                        color: rgb(0, 0, 0)
                    });
                    // Ligne 2 de la croix
                    firstPage.drawLine({
                        start: { x: pos.x + size, y: pos.y },
                        end: { x: pos.x, y: pos.y + size },
                        thickness: 2,
                        color: rgb(0, 0, 0)
                    });
                });

                const modifiedBuffer = await pdfDoc.save();
                return new Blob([modifiedBuffer], { type: 'application/pdf' });
            }

            displayPDF(blob) {
                const blobUrl = URL.createObjectURL(blob);
                document.getElementById('pdfViewer').src = blobUrl;
                document.getElementById('messageContainer').classList.add('hidden');
            }

            showError(title, message) {
                const msgContainer = document.getElementById('messageContainer');
                const msgContent = document.getElementById('messageContent');
                msgContent.innerHTML = `<div class="error-message">❌ ${title}</div><div class="error-details">${message}</div>`;
                msgContainer.classList.remove('hidden');
                document.getElementById('pdfViewer').classList.add('hidden');
            }

            updateStatus(text, type) {
                const badge = document.getElementById('statusBadge');
                document.getElementById('statusText').textContent = text;
                badge.className = `status-badge ${type}`;
            }

            downloadPDF() {
                if (!currentPdfBlob) return;
                const link = document.createElement('a');
                link.href = URL.createObjectURL(currentPdfBlob);
                link.download = isModified ? `modifie_${this.fileName}` : this.fileName;
                link.click();
            }
        }

        const viewer = new PDFViewer();
        document.getElementById('downloadBtn').addEventListener('click', () => viewer.downloadPDF());
    </script>
</body>
</html>
