<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur FTC - Configuration Finale</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: white; height: 100vh; display: flex; flex-direction: column; }
        
        header { 
            background: #1e1e1e; padding: 1rem 2rem; border-bottom: 2px solid #ff6b35; 
            display: flex; justify-content: space-between; align-items: center;
        }

        .controls { display: flex; gap: 15px; background: #252525; padding: 10px 20px; border-bottom: 1px solid #333; }
        .control-group { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; }
        input[type="number"] { background: #333; border: 1px solid #444; color: white; padding: 4px; width: 60px; border-radius: 4px; }

        #pdfContainer { flex: 1; background: #333; position: relative; }
        iframe { width: 100%; height: 100%; border: none; }

        #uploadOverlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 1000; display: flex; justify-content: center; align-items: center; 
        }
        .card { background: #252525; padding: 2rem; border-radius: 12px; text-align: center; border: 1px solid #444; max-width: 400px; }
        .card input { margin: 15px 0; display: block; width: 100%; color: #ccc; }
        
        button { background: #ff6b35; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { background: #e55a2b; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="uploadOverlay">
        <div class="card">
            <h2 style="color:#ff6b35">Fiche FTC</h2>
            <p style="color: #aaa; margin: 10px 0;">Veuillez charger les photos d'intervention</p>
            <input type="file" id="p1" accept="image/*">
            <input type="file" id="p2" accept="image/*">
            <button id="startBtn">Générer le Document</button>
        </div>
    </div>

    <header>
        <div id="docTitle">Aperçu FTC.pdf</div>
        <button id="dlBtn" class="hidden">Télécharger le PDF signé</button>
    </header>

    <div class="controls">
        <div class="control-group">
            <label>Viseur Test X:</label>
            <input type="number" id="test-x" value="170">
        </div>
        <div class="control-group">
            <label>Y:</label>
            <input type="number" id="test-y" value="220">
        </div>
        <span style="color:#666; font-size:0.7rem; margin-left:10px;">(Modifiez pour ajuster les photos en temps réel)</span>
    </div>

    <main id="pdfContainer">
        <iframe id="viewer"></iframe>
    </main>

    <script>
        const { PDFDocument, rgb } = PDFLib;

        // --- CONFIGURATION DES CENTRES (Tes valeurs exactes) ---
        const FTC_CENTERS = {
            0:  { x: 88,  y: 606 }, // Gaine verte
            1:  { x: 160, y: 606 }, // Regard
            2:  { x: 239, y: 624 }, // Tube IRO
            3:  { x: 242, y: 565 }, // Gaine murale
            4:  { x: 345, y: 603 }, // Gaine int
            5:  { x: 444, y: 606 }, // Goulotte
            6:  { x: 108, y: 468 }, // Elagage
            7:  { x: 181, y: 468 }, // Débouchage
            8:  { x: 251, y: 468 }, // Local technique
            9:  { x: 326, y: 482 }, // Maison raccorder
            10: { x: 326, y: 461 }, // Elec compl
            11: { x: 326, y: 445 }, // Accès
            12: { x: 326, y: 426 }, // Sondage
            13: { x: 326, y: 416 }  // Commentaire (Case)
        };

        // Paramètres de taille pour le centrage
        const CROSS_SIZE = 12; 
        const PHOTO_WIDTH = 175;
        const PHOTO_HEIGHT = 110;

        async function generateFTC() {
            if(!imgBuf1) return;

            try {
                const res = await fetch(fileName);
                const pdfBytes = await res.arrayBuffer();
                const pdfDoc = await PDFDocument.load(pdfBytes);
                const page = pdfDoc.getPages()[0];

                if (extraData) {
                    const [mask, commentBase64] = extraData.split(',');
                    
                    // 1. DESSINER LES CROIX CENTRÉES
                    for(let i=0; i < mask.length; i++) {
                        if(mask[i] === "1" && FTC_CENTERS[i]) {
                            const pos = FTC_CENTERS[i];
                            // On retire la moitié de la taille pour centrer
                            drawCenteredCross(page, pos.x, pos.y, CROSS_SIZE);
                        }
                    }

                    // 2. TEXTE DU COMMENTAIRE (Placé à droite de la case 13)
                    if (commentBase64) {
                        const bytes = Uint8Array.from(atob(commentBase64.trim()), c => c.charCodeAt(0));
                        const text = new TextDecoder().decode(bytes);
                        page.drawText(text, { x: 345, y: 412, size: 9, color: rgb(0,0,0) });
                    }
                }

                // 3. INSERTION DES PHOTOS CENTRÉES
                const img1 = await embedSafe(pdfDoc, imgBuf1);
                const img2 = await embedSafe(pdfDoc, imgBuf2);

                // Photo 1 : Centre à (170, 220)
                page.drawImage(img1, { 
                    x: 170 - (PHOTO_WIDTH / 2), 
                    y: 220 - (PHOTO_HEIGHT / 2), 
                    width: PHOTO_WIDTH, 
                    height: PHOTO_HEIGHT 
                });

                // Photo 2 : Centre à (380, 220)
                page.drawImage(img2, { 
                    x: 380 - (PHOTO_WIDTH / 2), 
                    y: 220 - (PHOTO_HEIGHT / 2), 
                    width: PHOTO_WIDTH, 
                    height: PHOTO_HEIGHT 
                });

                // ... (Reste du code d'affichage identique)
            } catch (e) { console.error(e); }
        }

        // Nouvelle fonction pour centrer la croix sur le point donné
        function drawCenteredCross(page, centerX, centerY, size) {
            const half = size / 2;
            const color = rgb(0, 0, 0);
            
            // Ligne 1 : du haut-gauche au bas-droit
            page.drawLine({
                start: { x: centerX - half, y: centerY + half },
                end: { x: centerX + half, y: centerY - half },
                thickness: 1.5,
                color
            });
            // Ligne 2 : du bas-gauche au haut-droit
            page.drawLine({
                start: { x: centerX - half, y: centerY - half },
                end: { x: centerX + half, y: centerY + half },
                thickness: 1.5,
                color
            });
        }

        let imgBuf1, imgBuf2;
        const urlParams = new URLSearchParams(window.location.search);
        const rawParam = urlParams.get('file') || "FTC.pdf";
        const [fileName, extraData] = rawParam.split('/');

        // Init
        document.getElementById('startBtn').onclick = async () => {
            const f1 = document.getElementById('p1').files[0];
            const f2 = document.getElementById('p2').files[0];
            if(!f1 || !f2) return alert("Sélectionnez les 2 photos");

            imgBuf1 = await f1.arrayBuffer();
            imgBuf2 = await f2.arrayBuffer();

            document.getElementById('uploadOverlay').classList.add('hidden');
            generateFTC();
        };

        // Rafraîchissement auto pour le calibrage
        document.getElementById('test-x').oninput = generateFTC;
        document.getElementById('test-y').oninput = generateFTC;

        async function generateFTC() {
            if(!imgBuf1) return;

            try {
                const res = await fetch(fileName);
                const pdfBytes = await res.arrayBuffer();
                const pdfDoc = await PDFDocument.load(pdfBytes);
                const page = pdfDoc.getPages()[0];

                // 1. TRAITEMENT DES CROIX (Binaire)
                if (extraData) {
                    const [mask, commentBase64] = extraData.split(',');
                    
                    // Parcours du masque binaire
                    for(let i=0; i < mask.length; i++) {
                        if(mask[i] === "1" && FTC_POSITIONS[i]) {
                            drawCross(page, FTC_POSITIONS[i].x, FTC_POSITIONS[i].y, rgb(0,0,0));
                        }
                    }

                    // 2. COMMENTAIRE TEXTUEL (Position 326, 416 ou selon ton besoin)
                    if (commentBase64) {
                        const bytes = Uint8Array.from(atob(commentBase64.trim()), c => c.charCodeAt(0));
                        const text = new TextDecoder().decode(bytes);
                        page.drawText(text, { x: 345, y: 416, size: 9, color: rgb(0,0,0) });
                    }
                }

                // 3. INSERTION DES PHOTOS
                const img1 = await embedSafe(pdfDoc, imgBuf1);
                const img2 = await embedSafe(pdfDoc, imgBuf2);

                // On utilise les inputs pour le réglage final des photos
                const tx = parseInt(document.getElementById('test-x').value);
                const ty = parseInt(document.getElementById('test-y').value);

                // Photo 1 (Position identifiée : 170, 220)
                page.drawImage(img1, { x: tx, y: ty, width: 175, height: 110 });
                // Photo 2 (Position identifiée : 380, 220)
                // On garde le même écart de 210px entre les deux photos
                page.drawImage(img2, { x: tx + 210, y: ty, width: 175, height: 110 });

                // 4. AFFICHAGE
                const pdfFinal = await pdfDoc.save();
                const blob = new Blob([pdfFinal], { type: 'application/pdf' });
                document.getElementById('viewer').src = URL.createObjectURL(blob);
                
                document.getElementById('dlBtn').classList.remove('hidden');
                document.getElementById('dlBtn').onclick = () => {
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = "FTC_Finalise.pdf";
                    a.click();
                };

            } catch (e) { console.error("Erreur PDF:", e); }
        }

        function drawCross(page, x, y, color) {
            const s = 10; // Taille de la croix
            page.drawLine({ start: {x, y}, end: {x: x+s, y: y+s}, thickness: 1.5, color });
            page.drawLine({ start: {x: x+s, y}, end: {x, y: y+s}, thickness: 1.5, color });
        }

        async function embedSafe(doc, buf) {
            try { return await doc.embedJpg(buf); } 
            catch { return await doc.embedPng(buf); }
        }
    </script>
</body>
</html>
