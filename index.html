<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Modificateur de PDF Dynamique</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: #333; }
        header { background: #222; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .btn { background: #e67e22; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; }
        #pdf-viewer { flex-grow: 1; border: none; }
    </style>
</head>
<body>

<header>
    <span id="status">Chargement du document...</span>
    <button id="downloadBtn" class="btn" style="display:none;">Télécharger avec la Croix</button>
</header>

<iframe id="pdf-viewer"></iframe>

<script>
    async function processPDF() {
        const { PDFDocument, rgb } = PDFLib;
        
        // 1. Analyse de l'URL (ex: ?file=FTC.pdf/1)
        const urlParams = new URLSearchParams(window.location.search);
        const rawParam = urlParams.get('file') || "";
        
        const hasCross = rawParam.endsWith('/1');
        const fileName = hasCross ? rawParam.replace('/1', '') : rawParam;

        if (!fileName) {
            document.getElementById('status').textContent = "Erreur : Aucun fichier spécifié.";
            return;
        }

        try {
            // 2. Récupération du fichier PDF original
            const existingPdfBytes = await fetch(`./${fileName}`).then(res => {
                if (!res.ok) throw new Error("Fichier introuvable");
                return res.arrayBuffer();
            });

            // 3. Charger le PDF dans PDF-lib
            const pdfDoc = await PDFDocument.load(existingPdfBytes);
            const pages = pdfDoc.getPages();
            const firstPage = pages[0];

            // 4. Si "/1" est présent, on dessine la croix
            if (hasCross) {
                const { width, height } = firstPage.getSize();
                // Coordonnées (x, y). Note : 0,0 est en BAS à GAUCHE
                const x = 100; 
                const y = height - 100; 
                const size = 20;

                // Dessiner la croix (deux lignes)
                firstPage.drawLine({ start: { x, y }, end: { x: x + size, y: y + size }, thickness: 2, color: rgb(1, 0, 0) });
                firstPage.drawLine({ start: { x: x + size, y }, end: { x, y: y + size }, thickness: 2, color: rgb(1, 0, 0) });
                
                document.getElementById('status').textContent = `Document : ${fileName} (Option /1 activée)`;
            } else {
                document.getElementById('status').textContent = `Document : ${fileName}`;
            }

            // 5. Générer le nouveau PDF
            const pdfDataUri = await pdfDoc.saveAsBase64({ dataUri: true });

            // 6. L'afficher dans l'iframe
            document.getElementById('pdf-viewer').src = pdfDataUri;

            // 7. Configurer le bouton de téléchargement
            const downloadBtn = document.getElementById('downloadBtn');
            downloadBtn.style.display = 'block';
            downloadBtn.onclick = async () => {
                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: "application/pdf" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = hasCross ? "modifie.pdf" : fileName;
                link.click();
            };

        } catch (err) {
            document.getElementById('status').textContent = "Erreur : " + err.message;
        }
    }

    processPDF();
</script>
</body>
</html>
